<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Inventory</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .category-header {
      background-color: #ddd;
      font-weight: bold;
    }
    button {
      margin-right: 5px;
    }
    .gender-select {
      width: 100%;
      box-sizing: border-box;
    }
    input.size-input {
      width: 4ch;
      box-sizing: border-box;
    }
  </style>
</head>
<body>

  <h1>Inventory Manager</h1>

  <!-- Import/Export Buttons -->
  <div style="display: flex; gap: 10px; margin-bottom: 20px;">
    <button id="importInventoryBtn">Import Inventory</button>
    <button id="exportInventoryBtn">Export Inventory</button>
    <input type="file" id="importInventoryFile" accept=".csv" style="display: none;" />
  </div>

  <h2>Add Product</h2>
  <form id="productForm">
    <div>
      <label>Category:
        <input type="text" id="category" required />
      </label>
    </div>

    <div>
      <label>Product Name:
        <input type="text" id="productName" required />
      </label>
    </div>

    <fieldset>
      <legend>Gender:</legend>
      <label><input type="checkbox" name="gender" value="M" /> M</label>
      <label><input type="checkbox" name="gender" value="F" /> F</label>
      <label><input type="checkbox" name="gender" value="Unisex" /> F</label>
    </fieldset>
    <button type="submit">Add Product</button>
  </form>

  <table id="inventoryTable">
    <thead>
      <tr>
        <th>Product Name</th>
        <th>Gender</th>
        <th>Size XS</th>
        <th>Size S</th>
        <th>Size M</th>
        <th>Size L</th>
        <th>Size XL</th>
        <th>Size 2XL</th>
        <th>Size 3XL</th>
        <th>Size 4XL</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let inventory = {};
    const form = document.getElementById('productForm');
    const tableBody = document.querySelector('#inventoryTable tbody');
    const importBtn = document.getElementById('importInventoryBtn');
    const exportBtn = document.getElementById('exportInventoryBtn');
    const importFileInput = document.getElementById('importInventoryFile');

    const sizes = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL'];

    window.addEventListener('DOMContentLoaded', () => {
      const data = localStorage.getItem('inventoryData');
      if (data) {
        inventory = JSON.parse(data);
        renderTable();
      }
    });

    function saveToLocalStorage() {
      localStorage.setItem('inventoryData', JSON.stringify(inventory));
    }

    function renderTable() {
      tableBody.innerHTML = '';

      Object.keys(inventory).sort().forEach(category => {
        const headerRow = document.createElement('tr');
        const headerCell = document.createElement('td');
        headerCell.colSpan = 11;
        headerCell.className = 'category-header';
        headerCell.textContent = category;
        headerRow.appendChild(headerCell);
        tableBody.appendChild(headerRow);

        inventory[category].sort((a, b) => a.productName.localeCompare(b.productName)).forEach(product => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="prod-name">${escapeHTML(product.productName)}</td>
            <td class="gender-display">${product.gender}</td>
            ${sizes.map(size => `<td class="size" data-size="${size}">${product.sizes[size]}</td>`).join('')}
            <td>
              <button class="edit-btn">Edit</button>
              <button class="delete-btn">Delete</button>
            </td>
          `;
          tableBody.appendChild(row);

          row.querySelector('.edit-btn').addEventListener('click', () => toggleEdit(row, product, category));
          row.querySelector('.delete-btn').addEventListener('click', () => {
            inventory[category] = inventory[category].filter(p => p !== product);
            if (inventory[category].length === 0) delete inventory[category];
            saveToLocalStorage();
            renderTable();
          });
        });
      });
    }

    function escapeHTML(text) {
      return text.replace(/[&<>"']/g, m => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[m]));
    }

    function toggleEdit(row, product, category) {
      const isEditing = row.classList.toggle('editing');

      if (isEditing) {
        const prodNameCell = row.querySelector('.prod-name');
        prodNameCell.innerHTML = `<input type="text" value="${escapeHTML(product.productName)}" />`;

        const genderCell = row.querySelector('.gender-display');
        genderCell.innerHTML = `
          <select class="gender-select">
            <option value="M" ${product.gender === 'M' ? 'selected' : ''}>M</option>
            <option value="F" ${product.gender === 'F' ? 'selected' : ''}>F</option>
            <option value="Unisex" ${product.gender === 'Unisex' || product.gender === 'U' ? 'selected' : ''}>Unisex</option>
          </select>
        `;

        row.querySelectorAll('.size').forEach(td => {
          const size = td.dataset.size;
          td.innerHTML = `<input type="number" min="0" class="size-input" value="${product.sizes[size]}" />`;
        });

        const actionCell = row.querySelector('td:last-child');
        actionCell.innerHTML = `
          <button class="save-btn">Save</button>
          <button class="cancel-btn">Cancel</button>
        `;

        actionCell.querySelector('.save-btn').addEventListener('click', () => {
          const newName = prodNameCell.querySelector('input').value.trim();
          if (!newName) {
            alert('Product name cannot be empty.');
            return;
          }
          product.productName = newName;

          const genderSelect = genderCell.querySelector('select');
          product.gender = genderSelect.value;

          row.querySelectorAll('.size').forEach(td => {
            const size = td.dataset.size;
            let val = parseInt(td.querySelector('input').value);
            product.sizes[size] = isNaN(val) || val < 0 ? 0 : val;
          });

          saveToLocalStorage();
          renderTable();
        });

        actionCell.querySelector('.cancel-btn').addEventListener('click', () => {
          renderTable();
        });

      } else {
        renderTable();
      }
    }

    form.addEventListener('submit', e => {
      e.preventDefault();

      const category = document.getElementById('category').value.trim();
      const productName = document.getElementById('productName').value.trim();

      const genderBoxes = Array.from(document.querySelectorAll('input[name="gender"]:checked'));
      let gender;
      if (genderBoxes.length === 0) {
        alert('Please select at least one gender.');
        return;
      } else if (genderBoxes.length === 1) {
        gender = genderBoxes[0].value;
      } else {
        gender = genderBoxes.map(cb => cb.value).join('/');
      }

      if (!category || !productName) return;

      if (!inventory[category]) inventory[category] = [];

      inventory[category].push({
        productName,
        gender,
        sizes: sizes.reduce((acc, size) => {
          acc[size] = 0;
          return acc;
        }, {})
      });

      form.reset();
      saveToLocalStorage();
      renderTable();
    });

    exportBtn.addEventListener('click', () => {
      const rows = [
        ['Category','Product Name','Gender', ...sizes]
      ];

      Object.keys(inventory).forEach(category => {
        inventory[category].forEach(product => {
          rows.push([
            category,
            product.productName,
            product.gender,
            ...sizes.map(size => product.sizes[size] ?? 0)
          ]);
        });
      });

      const csvContent = rows.map(row => row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(',')).join('\n');
      const blob = new Blob([csvContent], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'inventory.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', () => {
      importFileInput.value = '';
      importFileInput.click();
    });

    importFileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = evt => {
        const text = evt.target.result;
        parseCSVAndLoadInventory(text);
      };
      reader.readAsText(file);
    });

    function parseCSVAndLoadInventory(csvText) {
      const lines = csvText.trim().split('\n');
      if (lines.length < 2) {
        alert('CSV file appears empty or invalid.');
        return;
      }

      inventory = {};

      const headerCols = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const expectedHeaders = ['Category','Product Name','Gender', ...sizes];

      for (let i = 1; i < lines.length; i++) {
        const cols = parseCSVLine(lines[i]);
        if (cols.length < expectedHeaders.length) continue;

        const [category, productName, gender, ...qtys] = cols;

        if (!category || !productName) continue;

        if (!inventory[category]) inventory[category] = [];

        const sizesObj = {};
        sizes.forEach((size, idx) => {
          sizesObj[size] = parseInt(qtys[idx]) || 0;
        });

        inventory[category].push({
          productName: productName.trim(),
          gender: gender.trim(),
          sizes: sizesObj
        });
      }

      saveToLocalStorage();
      renderTable();
      alert('Inventory imported successfully!');
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];

        if (char === '"' && (i === 0 || line[i-1] !== '\\')) {
          inQuotes = !inQuotes;
          continue;
        }

        if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
          continue;
        }

        current += char;
      }
      result.push(current.trim());

      return result;
    }
  </script>

</body>
</html>