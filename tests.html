let db;

// Open the DB
const request = indexedDB.open("BandPOSDB", 1);

request.onupgradeneeded = function (event) {
  db = event.target.result;
  if (!db.objectStoreNames.contains("products")) {
    db.createObjectStore("products", { keyPath: "id", autoIncrement: true });
  }
};

request.onsuccess = function (event) {
  db = event.target.result;
  setupForm();
  loadInventory();
};

request.onerror = function (event) {
  alert("Failed to open database: " + event.target.errorCode);
};

// Set up form listener
function setupForm() {
  const form = document.getElementById("productForm");

  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const name = document.getElementById("productName").value.trim();
    const category = document.getElementById("productCategory").value.trim();
    const price = parseFloat(document.getElementById("productPrice").value);
    const gender = document.querySelector('input[name="gender"]:checked')?.value || "";
    const hasSizes = document.getElementById("productHasSizes").checked;
    const imageInput = document.getElementById("productImage").files[0];

    const variants = hasSizes
      ? ["S", "M", "L", "XL", "2XL"].map(size => ({ size, stock: 0 }))
      : [{ size: "One Size", stock: 0 }];

    const newProduct = {
      name, category, price, gender, variants, image: null
    };

    if (imageInput) {
      const reader = new FileReader();
      reader.onload = function () {
        newProduct.image = reader.result;
        saveProduct(newProduct);
      };
      reader.readAsDataURL(imageInput);
    } else {
      saveProduct(newProduct);
    }

    form.reset();
  });
}

// Save product to DB
function saveProduct(product) {
  const tx = db.transaction("products", "readwrite");
  const store = tx.objectStore("products");
  store.add(product).onsuccess = () => {
    loadInventory();
  };
}

// Display inventory in table
function loadInventory() {
  const tableBody = document.querySelector("#productTable tbody");
  tableBody.innerHTML = "";

  const tx = db.transaction("products", "readonly");
  const store = tx.objectStore("products");
  const request = store.openCursor();

  request.onsuccess = function (event) {
    const cursor = event.target.result;
    if (cursor) {
      const product = cursor.value;
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${product.name}</td>
        <td>${product.category}</td>
        <td>$${product.price.toFixed(2)}</td>
        <td>${product.gender}</td>
        <td>${product.variants.map(v => `${v.size}: ${v.stock}`).join(", ")}</td>
        <td>${product.image ? `<img src="${product.image}" />` : "None"}</td>
      `;

      tableBody.appendChild(row);
      cursor.continue();
    }
  };
}